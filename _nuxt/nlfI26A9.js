import{B as k,a as D}from"./6M5rhbXH.js";import{B as S}from"./WfD9c_UJ.js";import{d as E,a as z,r as T,U as w,x as i,z as t,B as h,O as I,I as p,R as _,S as g,y as o,M as u,A as a,V as L,C as B,D as b,T as N}from"#entry";const U={class:"readings-page"},q={class:"readings-container"},G={class:"readings"},P={class:"bold-title"},j={class:"account"},M={class:"small-text"},O={class:"reading-date"},$={class:"date"},F={style:{margin:"1em 0",display:"flex","align-items":"center",gap:".6em"}},K={key:0,class:"account-info"},H={class:"account-info-container"},J={class:"account-info-balance"},Q={class:"amount"},W={class:"account-info-district"},X={class:"small-text"},Y={class:"message"},Z={key:0,class:"account-success-message",style:{"font-size":"2em",color:"forestgreen",display:"flex","justify-content":"center","align-items":"center",gap:".2em",margin:".4em 0 0 0"}},tt={key:1,class:"account-error-message",style:{"font-size":"2em",color:"#c8290f",display:"flex","justify-content":"center","align-items":"center",gap:".2em",margin:".4em 0 0 0"}},et={key:0,class:"card-section"},st={class:"table-wrapper"},nt={class:"readings-table"},at={key:1,class:"card-section"},lt={class:"table-wrapper"},ot={class:"payments-table"},it={class:"small-text"},ct={class:"small-text amount"},rt={class:"small-text date"},dt={class:"small-text"},ut={key:2,class:"card-section"},mt={class:"table-wrapper"},pt={class:"issues-table"},yt={class:"small-text"},ht={class:"small-text"},_t={class:"small-text"},gt={class:"small-text"},ft={class:"small-text date"},St=E({__name:"index",setup(vt){const{$api:y}=z(),d=T(""),x=T(!1),m=w({}),c=w({type:"",message:""});async function R(){x.value=!0;const l={};d.value&&(l.search=d.value),l.limit=10,d.value&&(l.search=d.value);const s=await y("v2/facility/find",{method:"GET",query:l});{for(const e in m)delete m[e];for(const e of s.data)m[e.account]=e}x.value=!1}async function f(l){const s=await y("v2/facility/account",{method:"GET",query:{account:l.account}}),n=(await y("v1/payments/history",{method:"GET",query:{account:l.account},headers:[]})).data,r=l.account,v=m[r];m[r]={...s,...v,payments:n}}function A(l,s){y("v1/portal/readings",{method:"POST",body:{account:l.account,reading:s}}).then(e=>{f(l),setTimeout(()=>{c.type="success",c.message="Показание принято"})}).catch(e=>{console.error(e),setTimeout(()=>{c.type="error",c.message=e.data.message})}).finally(()=>{setTimeout(()=>{c.type=""},1e4)})}const C=(l,s=30)=>{const e=new Date(l),n=new Date;return e.setDate(e.getDate()+s),e<n};function V(l,s,e){if(!confirm("Вы уверены, что хотите удалить показание?"))return;e.target?.closest("tr")?.remove(),y("v1/portal/readings",{method:"DELETE",body:{account:l.account,id:s}}).then(r=>{f(l),setTimeout(()=>{c.type="success",c.message="Показание удалено"})}).catch(r=>{console.error(r),setTimeout(()=>{c.type="error",c.message=r.data.message})}).finally(()=>{setTimeout(()=>{c.type=""},1e4)})}return(l,s)=>(o(),i("section",U,[t("div",q,[s[12]||(s[12]=t("h1",{style:{"text-align":"center"}},"Абоненты",-1)),h(S,{modelValue:p(d),"onUpdate:modelValue":s[0]||(s[0]=e=>I(d)?d.value=e:null),autofocus:"",onSubmit:R,style:{width:"100%"},"prepend-icon":"mdi-magnify",button:"Найти",placeholder:"Поиск"},null,8,["modelValue"]),t("div",G,[(o(!0),i(_,null,g(p(m),e=>(o(),i("div",{class:"reading",key:String(e.name).slice(0,4)},[t("div",P,a(e.name),1),t("div",j,[t("span",null,a(e.account),1)]),t("div",M,a(e.address),1),t("div",O,[s[1]||(s[1]=t("span",null,"Создан: ",-1)),t("span",$,a(e.created),1)]),t("div",F,[h(S,{onSubmit:n=>{A(e,n)},style:{flex:"auto 1 0"},"prepend-icon":"mdi-counter",button:"Отправить",placeholder:"Отправить показание"},null,8,["onSubmit"]),e.district?u("",!0):(o(),L(k,{key:0,onClick:n=>f(e),prependIcon:"mdi-text-box-search-outline"},{default:B(()=>[...s[2]||(s[2]=[b("Подробнее",-1)])]),_:1},8,["onClick"]))]),e.district?(o(),i("section",K,[t("section",H,[t("div",J,[s[3]||(s[3]=t("span",{class:"small-text"},"Задолженность: ",-1)),t("span",Q,a(e.balance),1)]),t("div",W,[s[4]||(s[4]=t("span",{class:"small-text"},"Район: ",-1)),t("span",X,a(e.district),1)])]),t("section",Y,[p(c).type==="success"?(o(),i("div",Z,[t("span",null,[h(D,{name:"mdi-checkbox-marked-circle",size:"1.2em"})]),t("span",null,a(p(c).message),1)])):u("",!0),p(c).type==="error"?(o(),i("div",tt,[t("span",null,[h(D,{name:"mdi-alert-decagram",size:"1.2em"})]),t("span",null,a(p(c).message||"Ошибка при отправке"),1)])):u("",!0)]),Array.isArray(e?.readings)&&e.readings.length?(o(),i("section",et,[s[7]||(s[7]=t("h2",null,"История показаний",-1)),t("div",st,[t("table",nt,[s[6]||(s[6]=t("thead",null,[t("tr",null,[t("th",null,"Показание"),t("th",null,"Потребление"),t("th",null,"Дата"),t("th",null,"Отправитель"),t("th",null,"...")])],-1)),t("tbody",null,[(o(!0),i(_,null,g(e.readings,(n,r)=>(o(),i("tr",{key:r},[t("td",null,a(n.reading),1),t("td",{style:N({color:n.consumption>0?"green":"inherit"})},a(n.consumption),5),t("td",null,a(new Date(n.created).toLocaleDateString("RU-ru")),1),t("td",null,a(n.supplier.name),1),t("td",null,[h(k,{onClick:v=>V(e,n.id,v),"prepend-icon":"mdi-delete",disabled:C(n.created),variant:"secondary"},{default:B(()=>[...s[5]||(s[5]=[b("Удалить",-1)])]),_:1},8,["onClick","disabled"])])]))),128))])])])])):u("",!0),Array.isArray(e?.payments)&&e.payments.length?(o(),i("section",at,[s[9]||(s[9]=t("h2",null,"История платежей",-1)),t("div",lt,[t("table",ot,[s[8]||(s[8]=t("thead",null,[t("tr",null,[t("th",null,"Транзакция"),t("th",null,"Сумма"),t("th",null,"Дата"),t("th",null,"Услуга")])],-1)),t("tbody",null,[(o(!0),i(_,null,g(e.payments,(n,r)=>(o(),i("tr",{key:r},[t("td",it,a(n.txnId),1),t("td",ct,a(n.amount),1),t("td",rt,a(new Date(n.created).toLocaleDateString("RU-ru")),1),t("td",dt,"["+a(n.service.id)+"] "+a(n.service.name),1)]))),128))])])])])):u("",!0),Array.isArray(e?.applications)&&e.applications.length?(o(),i("section",ut,[s[11]||(s[11]=t("h2",null,"Заявки",-1)),t("div",mt,[t("table",pt,[s[10]||(s[10]=t("thead",null,[t("tr",null,[t("th",null,"Ключ"),t("th",null,"Название"),t("th",null,"Исполнитель"),t("th",null,"Статус"),t("th",null,"Дата")])],-1)),t("tbody",null,[(o(!0),i(_,null,g(e.applications,(n,r)=>(o(),i("tr",{key:r},[t("td",yt,a(n.issueKey),1),t("td",ht,a(n.summary),1),t("td",_t,a(n.assignee),1),t("td",gt,a(n.status.name),1),t("td",ft,a(new Date(n.created).toLocaleDateString("RU-ru")),1)]))),128))])])])])):u("",!0)])):u("",!0)]))),128))])])]))}});export{St as default};
