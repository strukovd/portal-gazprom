import{B as k,a as w}from"./DJrXkGIA.js";import{B as T}from"./BPW68NmM.js";import{g as V,e as z,m as b,X as D,c as i,a as t,b as h,Q as L,j as p,F as _,r as g,o as l,O as u,t as a,T as N,w as S,d as B,U}from"#entry";const q={class:"readings-page"},M={class:"readings-container"},j={class:"readings"},G={class:"bold-title"},I={class:"account"},F={class:"small-text"},O={class:"reading-date"},P={class:"date"},$={style:{margin:"1em 0",display:"flex","align-items":"center",gap:".6em"}},K={key:0,class:"account-info"},Q={class:"account-info-container"},X={class:"account-info-balance"},H={class:"amount"},J={class:"account-info-district"},W={class:"small-text"},Y={class:"message"},Z={key:0,class:"account-success-message",style:{"font-size":"2em",color:"forestgreen",display:"flex","justify-content":"center","align-items":"center",gap:".2em",margin:".4em 0 0 0"}},tt={key:1,class:"account-error-message",style:{"font-size":"2em",color:"#c8290f",display:"flex","justify-content":"center","align-items":"center",gap:".2em",margin:".4em 0 0 0"}},et={key:0,class:"card-section"},st={class:"table-wrapper"},nt={class:"readings-table"},at={key:1,class:"card-section"},ot={class:"table-wrapper"},lt={class:"payments-table"},it={class:"small-text amount"},ct={class:"small-text date"},rt={class:"small-text"},dt={key:2,class:"card-section"},ut={class:"table-wrapper"},mt={class:"issues-table"},pt={class:"small-text"},yt={class:"small-text"},ht={class:"small-text"},_t={class:"small-text"},gt={class:"small-text date"},wt=V({__name:"index",setup(ft){const{$api:y}=z(),d=b(""),x=b(!1),m=D({}),c=D({type:"",message:""});async function C(){x.value=!0;const o={};d.value&&(o.search=d.value),o.limit=10,d.value&&(o.search=d.value);const s=await y("v1/portal/abonents",{method:"GET",query:o});{for(const e in m)delete m[e];for(const e of s.data)m[e.account]=e}x.value=!1}async function f(o){const s=await y("v2/facility/account",{method:"GET",query:{account:o.account}}),n=(await y("v1/payments/history",{method:"GET",query:{account:o.account},headers:[]})).data,r=o.account,v=m[r];m[r]={...s,...v,payments:n}}function R(o,s){y("v1/portal/readings",{method:"POST",body:{account:o.account,reading:s}}).then(e=>{f(o),setTimeout(()=>{c.type="success",c.message="Показание принято"})}).catch(e=>{console.error(e),setTimeout(()=>{c.type="error",c.message=e.data.message})}).finally(()=>{setTimeout(()=>{c.type=""},1e4)})}const A=o=>{const s=new Date(o),e=new Date;return s.getMonth()===e.getMonth()};function E(o,s,e){if(!confirm("Вы уверены, что хотите удалить показание?"))return;e.target?.closest("tr")?.remove(),y("v1/portal/readings",{method:"DELETE",body:{account:o.account,id:s}}).then(r=>{f(o),setTimeout(()=>{c.type="success",c.message="Показание удалено"})}).catch(r=>{console.error(r),setTimeout(()=>{c.type="error",c.message=r.data.message})}).finally(()=>{setTimeout(()=>{c.type=""},1e4)})}return(o,s)=>(l(),i("section",q,[t("div",M,[s[12]||(s[12]=t("h1",{style:{"text-align":"center"}},"Абоненты",-1)),h(T,{modelValue:p(d),"onUpdate:modelValue":s[0]||(s[0]=e=>L(d)?d.value=e:null),autofocus:"",onSubmit:C,style:{width:"100%"},"prepend-icon":"mdi-magnify",button:"Найти",placeholder:"Поиск"},null,8,["modelValue"]),t("div",j,[(l(!0),i(_,null,g(p(m),e=>(l(),i("div",{class:"reading",key:String(e.name).slice(0,4)},[t("div",G,a(e.name),1),t("div",I,[t("span",null,a(e.account),1)]),t("div",F,a(e.address),1),t("div",O,[s[1]||(s[1]=t("span",null,"Создан: ",-1)),t("span",P,a(e.created),1)]),t("div",$,[h(T,{onSubmit:n=>{R(e,n)},style:{flex:"auto 1 0"},"prepend-icon":"mdi-counter",button:"Отправить",placeholder:"Отправить показание"},null,8,["onSubmit"]),e.district?u("",!0):(l(),N(k,{key:0,onClick:n=>f(e),prependIcon:"mdi-text-box-search-outline"},{default:S(()=>[...s[2]||(s[2]=[B("Подробнее",-1)])]),_:1},8,["onClick"]))]),e.district?(l(),i("section",K,[t("section",Q,[t("div",X,[s[3]||(s[3]=t("span",{class:"small-text"},"Задолженность: ",-1)),t("span",H,a(e.balance),1)]),t("div",J,[s[4]||(s[4]=t("span",{class:"small-text"},"Район: ",-1)),t("span",W,a(e.district),1)])]),t("section",Y,[p(c).type==="success"?(l(),i("div",Z,[t("span",null,[h(w,{name:"mdi-checkbox-marked-circle",size:"1.2em"})]),t("span",null,a(p(c).message),1)])):u("",!0),p(c).type==="error"?(l(),i("div",tt,[t("span",null,[h(w,{name:"mdi-alert-decagram",size:"1.2em"})]),t("span",null,a(p(c).message||"Ошибка при отправке"),1)])):u("",!0)]),Array.isArray(e?.readings)&&e.readings.length?(l(),i("section",et,[s[7]||(s[7]=t("h2",null,"История показаний",-1)),t("div",st,[t("table",nt,[s[6]||(s[6]=t("thead",null,[t("tr",null,[t("th",null,"Показание"),t("th",null,"Потребление"),t("th",null,"Дата"),t("th",null,"Отправитель"),t("th",null,"...")])],-1)),t("tbody",null,[(l(!0),i(_,null,g(e.readings,(n,r)=>(l(),i("tr",{key:r},[t("td",null,a(n.reading),1),t("td",{style:U({color:n.consumption>0?"green":"inherit"})},a(n.consumption),5),t("td",null,a(new Date(n.created).toLocaleDateString("RU-ru")),1),t("td",null,a(n.supplier.name),1),t("td",null,[h(k,{onClick:v=>E(e,n.id,v),"prepend-icon":"mdi-delete",disabled:!A(n.created),variant:"secondary"},{default:S(()=>[...s[5]||(s[5]=[B("Удалить",-1)])]),_:1},8,["onClick","disabled"])])]))),128))])])])])):u("",!0),Array.isArray(e?.payments)&&e.payments.length?(l(),i("section",at,[s[9]||(s[9]=t("h2",null,"История платежей",-1)),t("div",ot,[t("table",lt,[s[8]||(s[8]=t("thead",null,[t("tr",null,[t("th",null,"Сумма"),t("th",null,"Дата"),t("th",null,"Услуга")])],-1)),t("tbody",null,[(l(!0),i(_,null,g(e.payments,(n,r)=>(l(),i("tr",{key:r},[t("td",it,a(n.amount),1),t("td",ct,a(new Date(n.created).toLocaleDateString("RU-ru")),1),t("td",rt,"["+a(n.service.id)+"] "+a(n.service.name),1)]))),128))])])])])):u("",!0),Array.isArray(e?.applications)&&e.applications.length?(l(),i("section",dt,[s[11]||(s[11]=t("h2",null,"Заявки",-1)),t("div",ut,[t("table",mt,[s[10]||(s[10]=t("thead",null,[t("tr",null,[t("th",null,"Ключ"),t("th",null,"Название"),t("th",null,"Исполнитель"),t("th",null,"Статус"),t("th",null,"Дата")])],-1)),t("tbody",null,[(l(!0),i(_,null,g(e.applications,(n,r)=>(l(),i("tr",{key:r},[t("td",pt,a(n.issueKey),1),t("td",yt,a(n.summary),1),t("td",ht,a(n.assignee),1),t("td",_t,a(n.status.name),1),t("td",gt,a(new Date(n.created).toLocaleDateString("RU-ru")),1)]))),128))])])])])):u("",!0)])):u("",!0)]))),128))])])]))}});export{wt as default};
