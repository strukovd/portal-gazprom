import{B as k,a as T}from"./DJrXkGIA.js";import{B as w}from"./BPW68NmM.js";import{g as L,e as V,m as D,X as S,c as i,a as t,b as h,Q as N,j as p,F as _,r as g,o as l,O as u,t as a,T as U,w as b,d as B,U as z,k as q}from"#entry";const M={class:"readings-page"},j={class:"readings-container"},G={class:"readings"},I={class:"bold-title"},F={class:"account"},O={class:"small-text"},P={class:"reading-date"},$={class:"date"},K={style:{margin:"1em 0",display:"flex","align-items":"center",gap:".6em"}},Q={key:0,class:"account-info"},X={class:"account-info-container"},H={class:"account-info-balance"},J={class:"amount"},W={class:"account-info-district"},Y={class:"small-text"},Z={class:"message"},tt={key:0,class:"account-success-message",style:{"font-size":"2em",color:"forestgreen",display:"flex","justify-content":"center","align-items":"center",gap:".2em",margin:".4em 0 0 0"}},et={key:1,class:"account-error-message",style:{"font-size":"2em",color:"#c8290f",display:"flex","justify-content":"center","align-items":"center",gap:".2em",margin:".4em 0 0 0"}},st={key:0,class:"card-section"},nt={class:"table-wrapper"},at={class:"readings-table"},ot={key:1,class:"card-section"},lt={class:"table-wrapper"},it={class:"payments-table"},ct={class:"small-text amount"},rt={class:"small-text date"},dt={class:"small-text"},ut={key:2,class:"card-section"},mt={class:"table-wrapper"},pt={class:"issues-table"},yt={class:"small-text"},ht={class:"small-text"},_t={class:"small-text"},gt={class:"small-text"},ft={class:"small-text date"},wt=L({__name:"index",setup(vt){const{$api:y}=V(),d=D(""),x=D(!1),m=S({}),c=S({type:"",message:""});async function C(){x.value=!0;const o={};d.value&&(o.search=d.value),o.limit=10,d.value&&(o.search=d.value);const e=q().userData.role==="CALLCENTER"?"v2/facility/find":"v1/portal/abonents",s=await y(e,{method:"GET",query:o});{for(const n in m)delete m[n];for(const n of s.data)m[n.account]=n}x.value=!1}async function f(o){const e=await y("v2/facility/account",{method:"GET",query:{account:o.account}}),n=(await y("v1/payments/history",{method:"GET",query:{account:o.account},headers:[]})).data,r=o.account,v=m[r];m[r]={...e,...v,payments:n}}function E(o,e){y("v1/portal/readings",{method:"POST",body:{account:o.account,reading:e}}).then(s=>{f(o),setTimeout(()=>{c.message="Показание принято",c.type="success"})}).catch(s=>{console.error(s),setTimeout(()=>{c.message=s?.data?.message??"Ошибка при отправке",c.type="error"})}).finally(()=>{setTimeout(()=>{c.type=""},1e4)})}const R=o=>{const e=new Date(o),s=new Date;return e.getMonth()===s.getMonth()};function A(o,e,s){if(!confirm("Вы уверены, что хотите удалить показание?"))return;s.target?.closest("tr")?.remove(),y("v1/portal/readings",{method:"DELETE",body:{account:o.account,id:e}}).then(r=>{f(o),setTimeout(()=>{c.message="Показание удалено",c.type="success"})}).catch(r=>{console.error(r),setTimeout(()=>{c.message=r?.data?.message??"Ошибка при отправке",c.type="error"})}).finally(()=>{setTimeout(()=>{c.type=""},1e4)})}return(o,e)=>(l(),i("section",M,[t("div",j,[e[12]||(e[12]=t("h1",{style:{"text-align":"center"}},"Абоненты",-1)),h(w,{modelValue:p(d),"onUpdate:modelValue":e[0]||(e[0]=s=>N(d)?d.value=s:null),autofocus:"",onSubmit:C,style:{width:"100%"},"prepend-icon":"mdi-magnify",button:"Найти",placeholder:"Поиск"},null,8,["modelValue"]),t("div",G,[(l(!0),i(_,null,g(p(m),s=>(l(),i("div",{class:"reading",key:String(s.name).slice(0,4)},[t("div",I,a(s.name),1),t("div",F,[t("span",null,a(s.account),1)]),t("div",O,a(s.address),1),t("div",P,[e[1]||(e[1]=t("span",null,"Создан: ",-1)),t("span",$,a(s.created),1)]),t("div",K,[h(w,{onSubmit:n=>{E(s,n)},style:{flex:"auto 1 0"},"prepend-icon":"mdi-counter",button:"Отправить",placeholder:"Отправить показание"},null,8,["onSubmit"]),s.district?u("",!0):(l(),U(k,{key:0,onClick:n=>f(s),prependIcon:"mdi-text-box-search-outline"},{default:b(()=>[...e[2]||(e[2]=[B("Подробнее",-1)])]),_:1},8,["onClick"]))]),s.district?(l(),i("section",Q,[t("section",X,[t("div",H,[e[3]||(e[3]=t("span",{class:"small-text"},"Задолженность: ",-1)),t("span",J,a(s.balance),1)]),t("div",W,[e[4]||(e[4]=t("span",{class:"small-text"},"Район: ",-1)),t("span",Y,a(s.district),1)])]),t("section",Z,[p(c).type==="success"?(l(),i("div",tt,[t("span",null,[h(T,{name:"mdi-checkbox-marked-circle",size:"1.2em"})]),t("span",null,a(p(c).message),1)])):u("",!0),p(c).type==="error"?(l(),i("div",et,[t("span",null,[h(T,{name:"mdi-alert-decagram",size:"1.2em"})]),t("span",null,a(p(c).message||"Ошибка при отправке"),1)])):u("",!0)]),Array.isArray(s?.readings)&&s.readings.length?(l(),i("section",st,[e[7]||(e[7]=t("h2",null,"История показаний",-1)),t("div",nt,[t("table",at,[e[6]||(e[6]=t("thead",null,[t("tr",null,[t("th",null,"Показание"),t("th",null,"Потребление"),t("th",null,"Дата"),t("th",null,"Отправитель"),t("th",null,"...")])],-1)),t("tbody",null,[(l(!0),i(_,null,g(s.readings,(n,r)=>(l(),i("tr",{key:r},[t("td",null,a(n.reading),1),t("td",{style:z({color:n.consumption>0?"green":"inherit"})},a(n.consumption),5),t("td",null,a(new Date(n.created).toLocaleDateString("RU-ru")),1),t("td",null,a(n.supplier.name),1),t("td",null,[h(k,{onClick:v=>A(s,n.id,v),"prepend-icon":"mdi-delete",disabled:!R(n.created),variant:"secondary"},{default:b(()=>[...e[5]||(e[5]=[B("Удалить",-1)])]),_:1},8,["onClick","disabled"])])]))),128))])])])])):u("",!0),Array.isArray(s?.payments)&&s.payments.length?(l(),i("section",ot,[e[9]||(e[9]=t("h2",null,"История платежей",-1)),t("div",lt,[t("table",it,[e[8]||(e[8]=t("thead",null,[t("tr",null,[t("th",null,"Сумма"),t("th",null,"Дата"),t("th",null,"Услуга")])],-1)),t("tbody",null,[(l(!0),i(_,null,g(s.payments,(n,r)=>(l(),i("tr",{key:r},[t("td",ct,a(n.amount),1),t("td",rt,a(new Date(n.created).toLocaleDateString("RU-ru")),1),t("td",dt,"["+a(n.service.id)+"] "+a(n.service.name),1)]))),128))])])])])):u("",!0),Array.isArray(s?.applications)&&s.applications.length?(l(),i("section",ut,[e[11]||(e[11]=t("h2",null,"Заявки",-1)),t("div",mt,[t("table",pt,[e[10]||(e[10]=t("thead",null,[t("tr",null,[t("th",null,"Ключ"),t("th",null,"Название"),t("th",null,"Исполнитель"),t("th",null,"Статус"),t("th",null,"Дата")])],-1)),t("tbody",null,[(l(!0),i(_,null,g(s.applications,(n,r)=>(l(),i("tr",{key:r},[t("td",yt,a(n.issueKey),1),t("td",ht,a(n.summary),1),t("td",_t,a(n.assignee),1),t("td",gt,a(n.status.name),1),t("td",ft,a(new Date(n.created).toLocaleDateString("RU-ru")),1)]))),128))])])])])):u("",!0)])):u("",!0)]))),128))])])]))}});export{wt as default};
